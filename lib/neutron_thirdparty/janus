# Ryu OpenFlow Controller
# -----------------------

# Save trace setting
MY_XTRACE=$(set +o | grep xtrace)
set +o xtrace


RYU_DIR=$DEST/ryu
# Ryu API Host
JANUS_API_HOST=${JANUS_API_HOST:-127.0.0.1}
RYU_API_HOST=${RYU_API_HOST:-127.0.0.1}
# Ryu API Port
JANUS_API_PORT=${JANUS_API_PORT:-8091}
RYU_API_PORT=${RYU_API_PORT:-8090}
# Ryu OFP Host
RYU_OFP_HOST=${RYU_OFP_HOST:-127.0.0.1}
# Ryu OFP Port
RYU_OFP_PORT=${RYU_OFP_PORT:-6633}
# Ryu Applications
RYU_APPS=${RYU_APPS:-ryu.app.simple_isolation,ryu.app.rest}

# configure_ryu can be called multiple times as neutron_pluing/ryu may call
# this function for neutron-ryu-agent
_RYU_CONFIGURED=${_RYU_CONFIGURED:-False}
function configure_janus() {
    if [[ "$_RYU_CONFIGURED" == "False" ]]; then
        setup_develop $RYU_DIR
        _RYU_CONFIGURED=True
    fi
}

function init_janus() {
    RYU_CONF_DIR=/etc/ryu
    if [[ ! -d $RYU_CONF_DIR ]]; then
        sudo mkdir -p $RYU_CONF_DIR
    fi
    sudo chown $STACK_USER $RYU_CONF_DIR
    RYU_CONF=$RYU_CONF_DIR/ryu.conf
    sudo rm -rf $RYU_CONF

    # Ryu configuration
    RYU_CONF_CONTENTS=${RYU_CONF_CONTENTS:-"
--app_lists=$RYU_APPS
--wsapi_host=$RYU_API_HOST
--wsapi_port=$RYU_API_PORT
--ofp_listen_host=$RYU_OFP_HOST
--ofp_tcp_listen_port=$RYU_OFP_PORT
--janus_host=$JANUS_API_HOST
--janus_port=$JANUS_API_PORT
--api_db_url=$BASE_SQL_CONN/janus?charset=utf8
"}
    echo "${RYU_CONF_CONTENTS}" > $RYU_CONF
}

# install_ryu can be called multiple times as neutron_pluing/ryu may call
# this function for neutron-ryu-agent
# Make this function idempotent and avoid cloning same repo many times
# with RECLONE=yes
_RYU_INSTALLED=${_RYU_INSTALLED:-False}
function install_janus() {
    if [[ "$_RYU_INSTALLED" == "False" ]]; then
        git_clone $RYU_REPO $RYU_DIR $RYU_BRANCH
        _RYU_INSTALLED=True
    fi
}

function start_janus() {
    screen_it ryu "cd $RYU_DIR && $RYU_DIR/bin/ryu-manager --flagfile $RYU_CONF"
}

function stop_janus() {
    :
}

# Restore xtrace
$MY_XTRACE
